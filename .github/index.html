<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>EclairSecurity | All-in-One</title>
    <style>
        :root { --accent: #00ffcc; --bg: #050505; }
        body { background: var(--bg); color: var(--accent); font-family: monospace; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; text-align: center; }
        .box { border: 1px solid var(--accent); padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,255,204,0.2); width: 85%; }
        .btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 15px 20px; cursor: pointer; text-transform: uppercase; margin-top: 20px; width: 100%; }
        input { background: transparent; border: 1px solid #333; color: var(--accent); padding: 10px; text-align: center; font-size: 1.5rem; width: 80%; margin: 10px 0; outline: none; }
        .loader { display: none; margin: 20px auto; width: 30px; height: 30px; border: 2px solid #111; border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="box" id="app">
    <div id="step-init">
        <h1>EclairSecurity</h1>
        <p style="font-size: 12px; opacity: 0.6;">СИСТЕМА ЗАЩИТЫ В ОДНОМ ФАЙЛЕ</p>
        <button class="btn" onclick="goPin()">Активировать</button>
    </div>

    <div id="step-pin" class="hidden">
        <p>УСТАНОВИТЕ ПИН-КОД</p>
        <input type="text" id="pin" maxlength="5" placeholder="5-357">
        <button class="btn" onclick="installSystem()">Продолжить</button>
    </div>

    <div id="step-loading" class="hidden">
        <div class="loader" style="display:block;"></div>
        <p id="load-text">Развертывание CDN...</p>
    </div>

    <div id="step-ready" class="hidden">
        <h2 style="color: white;">АКТИВНО</h2>
        <p>Защита Eclair запущена.</p>
        <button class="btn" onclick="window.location.href='https://example.com'">Тест защиты</button>
    </div>
</div>

<script>
    const API_KEY = 'e78d3d84ead4488ae360bd94c11394a392255855737dca6ee8a0a3f84deefe3e';

    function goPin() {
        document.getElementById('step-init').classList.add('hidden');
        document.getElementById('step-pin').classList.remove('hidden');
    }

    async function installSystem() {
        const pin = document.getElementById('pin').value;
        if(pin.length < 3) return alert("Минимум 3 цифры");

        document.getElementById('step-pin').classList.add('hidden');
        document.getElementById('step-loading').classList.remove('hidden');

        // КОД CDN (Service Worker) внутри строки
        const swCode = `
            const API_KEY = '${API_KEY}';
            self.addEventListener('install', e => self.skipWaiting());
            self.addEventListener('activate', e => e.waitUntil(clients.claim()));

            self.addEventListener('fetch', event => {
                const url = new URL(event.request.url);
                if (event.request.mode === 'navigate' && !url.searchParams.has('eclr')) {
                    event.respondWith(handleSecurity(url.href));
                }
            });

            async function handleSecurity(target) {
                const html = \`
                <html>
                <body style="background:#000;color:#0f0;font-family:monospace;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;">
                    <div style="border:1px solid #0f0;padding:20px;text-align:center;">
                        <h2>EclairSecurity</h2>
                        <p id="msg">Проверка VirusTotal для: \${new URL(target).hostname}...</p>
                    </div>
                    <script>
                        async function check() {
                            try {
                                const id = btoa("\${target}").replace(/=/g, '');
                                const res = await fetch('www.virustotal.com' + id, {
                                    headers: { 'x-apikey': '\${API_KEY}' }
                                });
                                const d = await res.json();
                                if (d.data?.attributes?.last_analysis_stats?.malicious > 0) {
                                    document.getElementById('msg').innerText = "ВИРУС ОБНАРУЖЕН! БЛОКИРОВКА.";
                                    document.body.style.color = "red";
                                } else {
                                    location.href = "\${target}" + (target.includes('?') ? '&' : '?') + "eclr=1";
                                }
                            } catch(e) { location.href = "\${target}?eclr=1"; }
                        }
                        check();
                    <\\/script>
                </body>
                </html>\`;
                return new Response(html, { headers: { 'Content-Type': 'text/html' } });
            }
        `;

        // Создаем файл из строки прямо в браузере
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);

        try {
            await navigator.serviceWorker.register(swUrl);
            
            setTimeout(() => {
                document.getElementById('step-loading').classList.add('hidden');
                document.getElementById('step-ready').classList.remove('hidden');
            }, 2000);
        } catch (err) {
            alert("Ошибка: Сервис-воркеры требуют HTTPS или Localhost. Используйте GitHub Pages или онлайн тестер с HTTPS.");
        }
    }
</script>

</body>
</html>
